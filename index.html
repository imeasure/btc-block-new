import requests
import json
import os
import time
from datetime import datetime, timedelta, timezone

DATA_FILE = "data.json"

def get_beijing_time():
    """è·å–å½“å‰çš„åŒ—äº¬æ—¶é—´"""
    # UTC+8
    tz_bj = timezone(timedelta(hours=8))
    return datetime.now(tz_bj)

def get_latest_height():
    try:
        resp = requests.get("https://blockchain.info/latestblock", timeout=10)
        return resp.json()['height']
    except Exception as e:
        print(f"è·å–æœ€æ–°é«˜åº¦å¤±è´¥: {e}")
        return None

def get_block_top_3(block_hash):
    url = f"https://blockchain.info/rawblock/{block_hash}"
    try:
        resp = requests.get(url, timeout=30).json()
        all_txs = []
        for tx in resp['tx']:
            total_value = sum(out['value'] for out in tx['out']) / 100000000
            all_txs.append({"txid": tx['hash'], "value": total_value})
        
        all_txs.sort(key=lambda x: x['value'], reverse=True)
        return all_txs[:3]
    except Exception as e:
        print(f"è§£æåŒºå— {block_hash} å¤±è´¥: {e}")
        return []

def main():
    now_bj = get_beijing_time()
    today_str = now_bj.strftime("%Y-%m-%d")

    # 1. åŠ è½½æ•°æ®
    if os.path.exists(DATA_FILE):
        with open(DATA_FILE, "r") as f:
            store = json.load(f)
    else:
        init_height = get_latest_height()
        store = {
            "last_height": init_height - 1, 
            "last_date": today_str,
            "daily_max": {"value": 0, "txid": "N/A", "height": 0},
            "history": []
        }

    # 2. è·¨å¤©é‡ç½®é€»è¾‘
    if store.get("last_date") != today_str:
        print(f"ğŸ“… æ£€æµ‹åˆ°æ–°çš„ä¸€å¤© ({today_str})ï¼Œé‡ç½®ä»Šæ—¥æœ€å¤§è½¬è´¦ã€‚")
        store["daily_max"] = {"value": 0, "txid": "N/A", "height": 0}
        store["last_date"] = today_str

    current_height = get_latest_height()
    last_height = store["last_height"]

    if current_height and current_height > last_height:
        print(f"ğŸš€ å‘ç°æ–°åŒºå—: ä» {last_height + 1} åˆ° {current_height}")
        
        for h in range(last_height + 1, current_height + 1):
            print(f"æ­£åœ¨å¤„ç†é«˜åº¦: {h}...")
            time.sleep(1) 
            
            try:
                block_info = requests.get(f"https://blockchain.info/block-height/{h}?format=json", timeout=20).json()
                block_hash = block_info['blocks'][0]['hash']
                top_3 = get_block_top_3(block_hash)
                
                # æ›´æ–°ä»Šæ—¥æœ€å¤§
                if top_3 and top_3[0]['value'] > store["daily_max"]["value"]:
                    store["daily_max"] = {
                        "value": top_3[0]['value'],
                        "txid": top_3[0]['txid'],
                        "height": h
                    }

                store["history"].append({"height": h, "top_txs": top_3})
            except Exception as e:
                print(f"å¤„ç†åŒºå— {h} æ—¶å‡ºé”™: {e}")
                continue
        
        store["history"] = store["history"][-100:]
        store["last_height"] = current_height

        with open(DATA_FILE, "w") as f:
            json.dump(store, f, indent=4)
        print("âœ… æ•°æ®åŒæ­¥å®Œæˆ")
    else:
        print("ğŸ˜´ æš‚æ— æ–°åŒºå—")

if __name__ == "__main__":
    main()
