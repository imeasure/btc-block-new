<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Habfut BTC Intelligence Terminal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Roboto+Mono:wght@500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .font-mono { font-family: 'Roboto Mono', monospace; }
        .pro-card { background: #ffffff; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05); }
        .btc-gradient { background: linear-gradient(135deg, #f7931a 0%, #ffab40 100%); }
        .hover-card:hover { border-color: #f7931a; box-shadow: 0 12px 20px -5px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .sidebar-scroll::-webkit-scrollbar { width: 4px; }
        .sidebar-scroll::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        /* 图表容器 */
        .chart-container { position: relative; height: 180px; width: 100%; }
    </style>
</head>
<body class="antialiased overflow-x-hidden">

    <div id="auth-screen" class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-100/95 backdrop-blur-md transition-opacity duration-500">
        <div class="pro-card p-10 rounded-3xl shadow-2xl text-center max-w-sm w-full mx-4 relative">
            <div class="w-16 h-16 btc-gradient rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-xl shadow-orange-500/20 transform rotate-3">
                <i class="fab fa-bitcoin text-3xl text-white"></i>
            </div>
            <h2 class="text-2xl font-black mb-2 text-slate-800 tracking-tight">HABFUT TERMINAL</h2>
            <p class="text-slate-500 text-sm mb-6">请输入授权码以访问核心数据流</p>
            
            <input type="password" id="pw" class="w-full bg-slate-50 border border-slate-200 p-4 rounded-xl mb-4 text-center outline-none focus:ring-4 focus:ring-orange-100 transition-all font-mono" placeholder="••••••••">
            <button onclick="verify()" class="w-full btc-gradient py-3.5 rounded-xl font-black text-white shadow-lg shadow-orange-500/30 transition hover:brightness-110 active:scale-95 mb-4">验证并进入</button>
            
            <button onclick="skipAuth()" class="text-xs text-slate-400 font-bold hover:text-orange-500 transition underline decoration-dashed underline-offset-4">
                暂无密码？点击以访客身份浏览 &rarr;
            </button>
        </div>
    </div>

    <main id="main-content" class="hidden opacity-0 transition-opacity duration-700 flex-col h-screen overflow-hidden">
        <div class="container mx-auto px-4 py-6 flex flex-col h-full max-w-7xl">
            
            <header class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 bg-white p-4 rounded-3xl pro-card">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 btc-gradient rounded-2xl flex items-center justify-center shadow-lg shadow-orange-500/20">
                        <i class="fab fa-bitcoin text-white text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-black text-slate-900 tracking-tighter">HABFUT <span class="text-orange-600">INTEL</span></h1>
                        <div class="flex items-center text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">
                            <span class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></span>
                            Continuous Blockchain Monitor
                        </div>
                    </div>
                </div>
                <div class="bg-slate-900 text-white px-6 py-2 rounded-2xl flex items-center gap-4 shadow-2xl">
                    <div class="text-right border-r border-slate-700 pr-5">
                        <p class="text-[9px] text-slate-500 uppercase font-black leading-none mb-1">Beijing Time</p>
                        <p id="bj-clock" class="text-xl font-mono font-bold leading-none tracking-wider text-orange-400">00:00:00</p>
                    </div>
                    <i class="fas fa-clock text-slate-600 text-xl"></i>
                </div>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 flex-1 overflow-hidden">
                
                <div class="lg:col-span-4 space-y-6 overflow-y-auto sidebar-scroll pr-1">
                    <div class="pro-card p-8 rounded-3xl bg-white border-t-[6px] border-t-orange-500 relative group transition-all">
                        <div class="flex justify-between items-start mb-6">
                            <h3 class="text-slate-400 text-[11px] font-black uppercase tracking-widest">Today's Largest Transaction</h3>
                            <div class="bg-orange-50 text-orange-600 p-2 rounded-lg"><i class="fas fa-whale text-sm"></i></div>
                        </div>
                        <div class="flex items-baseline gap-3 mb-4">
                            <p class="text-5xl font-black text-slate-900 font-mono tracking-tighter" id="daily-max-val">0.00</p>
                            <p class="text-sm font-black text-orange-500 bg-orange-50 px-3 py-1 rounded-full uppercase">BTC</p>
                        </div>
                        <p class="text-[10px] font-mono text-slate-400 truncate bg-slate-50 p-3 rounded-xl mb-6" id="daily-max-txid">Waiting for data...</p>
                        <a id="daily-max-link" href="#" target="_blank" class="flex items-center justify-center gap-3 bg-slate-900 text-white py-4 rounded-2xl text-xs font-black hover:bg-orange-600 transition-all shadow-xl shadow-slate-900/10">
                            <i class="fas fa-external-link-alt"></i> 追踪详情
                        </a>
                    </div>

                    <div class="pro-card p-6 rounded-3xl bg-white">
                        <h3 class="text-slate-400 text-[11px] font-black uppercase tracking-widest mb-6">Network Health</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-slate-50 p-5 rounded-2xl border border-slate-100">
                                <p class="text-slate-400 text-[10px] font-black uppercase mb-2">Block Height</p>
                                <p class="text-2xl font-black text-slate-900 font-mono" id="stat-height">-</p>
                            </div>
                            <div class="bg-slate-50 p-5 rounded-2xl border border-slate-100">
                                <p class="text-slate-400 text-[10px] font-black uppercase mb-2">Sync Count</p>
                                <p class="text-2xl font-black text-orange-600 font-mono" id="stat-count">-</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-8 flex flex-col gap-6 overflow-hidden">
                    
                    <div class="pro-card p-6 rounded-3xl bg-white flex flex-col justify-between">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-slate-900 font-black text-sm uppercase tracking-wider flex items-center">
                                <i class="fas fa-chart-area text-orange-500 mr-2"></i> Max Transaction Trend
                            </h3>
                            <div class="flex bg-slate-100 rounded-lg p-1">
                                <button onclick="updateChart('24h')" id="btn-24h" class="text-[10px] font-bold px-3 py-1 rounded-md bg-white shadow text-slate-800 transition">24H</button>
                                <button onclick="updateChart('7d')" id="btn-7d" class="text-[10px] font-bold px-3 py-1 rounded-md text-slate-400 hover:text-slate-600 transition">7D</button>
                                <button onclick="updateChart('30d')" id="btn-30d" class="text-[10px] font-bold px-3 py-1 rounded-md text-slate-400 hover:text-slate-600 transition">30D</button>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="whaleChart"></canvas>
                        </div>
                    </div>

                    <div class="flex-1 flex flex-col pro-card rounded-3xl overflow-hidden bg-white">
                        <div class="px-8 py-4 border-b border-slate-100 bg-slate-50/30 flex justify-between items-center">
                            <div class="relative w-64">
                                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-300"></i>
                                <input type="text" id="searchInput" oninput="handleSearch()" placeholder="Search..." class="w-full text-xs font-bold pl-10 pr-4 py-2 bg-white border border-slate-200 rounded-xl outline-none focus:border-orange-500 transition-all">
                            </div>
                            <div id="pageInfo" class="text-[10px] font-black text-slate-400 font-mono">PAGE 1 / 1</div>
                        </div>

                        <div id="block-list" class="flex-1 overflow-y-auto p-8 space-y-6 bg-slate-50/50 custom-scrollbar">
                            </div>
                        
                        <div class="p-4 border-t border-slate-100 flex justify-between bg-white px-8">
                            <button onclick="prevPage()" id="prevBtn" class="text-[10px] font-black px-4 py-2 border border-slate-200 rounded-xl disabled:opacity-20 uppercase">Prev</button>
                            <button onclick="nextPage()" id="nextBtn" class="text-[10px] font-black px-4 py-2 border border-slate-200 rounded-xl disabled:opacity-20 uppercase">Next</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        let allData = [], filteredData = [], currentPage = 1;
        const pageSize = 20;
        let whaleChartInstance = null; // 图表实例

        function updateClock() {
            const now = new Date();
            const bjTime = new Date(now.getTime() + (now.getTimezoneOffset() + 480) * 60000);
            document.getElementById('bj-clock').innerText = bjTime.toTimeString().split(' ')[0];
        }
        setInterval(updateClock, 1000);
        updateClock();

        // 验证逻辑
        function verify() {
            if(document.getElementById('pw').value === 'habfut.com') {
                showMainContent();
            } else {
                alert('密码错误');
            }
        }

        // 跳过验证逻辑
        function skipAuth() {
            showMainContent();
            // 可以在这里加一个 localStorage 标记，记录用户是访客身份
        }

        function showMainContent() {
            const auth = document.getElementById('auth-screen');
            auth.classList.add('opacity-0');
            setTimeout(() => { 
                auth.remove(); 
                const main = document.getElementById('main-content');
                main.classList.replace('hidden', 'flex'); 
                setTimeout(() => main.classList.add('opacity-100'), 50);
                init();
            }, 400);
        }

        async function init() {
            try {
                // 替换为你的 GitHub Raw 地址
                const url = 'https://raw.githubusercontent.com/lovexw/btc-block-new/refs/heads/main/data.json?t=' + Date.now();
                const resp = await fetch(url);
                const data = await resp.json();
                
                document.getElementById('stat-height').innerText = data.last_height || '-';
                document.getElementById('stat-count').innerText = data.history.length;
                
                if(data.daily_max && data.daily_max.value > 0) {
                    document.getElementById('daily-max-val').innerText = data.daily_max.value.toFixed(2);
                    document.getElementById('daily-max-txid').innerText = data.daily_max.txid;
                    document.getElementById('daily-max-link').href = 'https://mempool.space/zh/tx/' + data.daily_max.txid;
                }

                // 处理历史数据
                allData = data.history.reverse();
                
                // 兼容旧数据：如果 monitor.py 还没跑，旧数据可能没 time 字段
                // 我们给它补一个模拟时间 (倒推，每块10分钟)
                let nowTs = Math.floor(Date.now() / 1000);
                allData.forEach((item, index) => {
                    if(!item.time) {
                        item.time = nowTs - (index * 600); 
                    }
                });

                filteredData = [...allData];
                render();
                
                // 初始化图表（默认 24H）
                initChart(allData);

            } catch (e) { console.error(e); }
        }

        // --- 图表相关逻辑 ---
        function initChart(data) {
            const ctx = document.getElementById('whaleChart').getContext('2d');
            
            // 初始数据：取最近24小时 (大约144个块)
            const slicedData = data.slice(0, 144).reverse(); // 图表需要从左到右的时间顺序，所以 reverse 回来

            whaleChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: slicedData.map(d => d.height), // X轴：高度
                    datasets: [{
                        label: 'Max TX Value (BTC)',
                        data: slicedData.map(d => d.top_txs[0].value),
                        borderColor: '#f97316', // Orange-500
                        backgroundColor: 'rgba(249, 115, 22, 0.1)',
                        borderWidth: 2,
                        pointRadius: 2,
                        pointHoverRadius: 5,
                        fill: true,
                        tension: 0.4 // 平滑曲线
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y.toFixed(2) + ' BTC';
                                }
                            }
                        }
                    },
                    scales: {
                        x: { display: false }, // 隐藏X轴标签，保持简洁
                        y: {
                            beginAtZero: true,
                            grid: { color: '#f1f5f9' },
                            ticks: { font: { size: 10 } }
                        }
                    }
                }
            });
        }

        function updateChart(period) {
            // 更新按钮样式
            ['24h', '7d', '30d'].forEach(p => {
                const btn = document.getElementById(`btn-${p}`);
                if (p === period) {
                    btn.className = "text-[10px] font-bold px-3 py-1 rounded-md bg-white shadow text-slate-800 transition";
                } else {
                    btn.className = "text-[10px] font-bold px-3 py-1 rounded-md text-slate-400 hover:text-slate-600 transition";
                }
            });

            // 筛选数据
            let count = 144; // 24h
            if (period === '7d') count = 144 * 7;
            if (period === '30d') count = 144 * 30;

            // 截取数据并反转（按时间正序）
            const newData = allData.slice(0, count).reverse();

            // 更新图表数据
            whaleChartInstance.data.labels = newData.map(d => d.height);
            whaleChartInstance.data.datasets[0].data = newData.map(d => d.top_txs[0].value);
            whaleChartInstance.update();
        }
        // --- 图表逻辑结束 ---

        function render() {
            const list = document.getElementById('block-list');
            list.innerHTML = '';
            const pageItems = filteredData.slice((currentPage-1)*pageSize, currentPage*pageSize);
            
            pageItems.forEach(block => {
                const card = document.createElement('div');
                card.className = 'pro-card p-6 rounded-3xl bg-white hover-card transition-all flex flex-col gap-5';
                
                let txs = block.top_txs.map((tx, i) => `
                    <div class="flex justify-between items-center py-3 border-b border-slate-50 last:border-0 group">
                        <div class="flex items-center gap-4 overflow-hidden">
                            <span class="w-8 h-8 rounded-xl bg-slate-50 flex items-center justify-center text-[10px] font-black text-slate-400 group-hover:bg-orange-50 group-hover:text-orange-600 transition-colors">#${i+1}</span>
                            <div class="flex flex-col truncate">
                                <span class="text-[8px] font-black text-slate-300 uppercase leading-none mb-1">TXID</span>
                                <span class="font-mono text-[11px] text-slate-500 truncate w-32 md:w-80 font-medium" title="${tx.txid}">${tx.txid}</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-5">
                            <div class="text-right">
                                <span class="font-black text-slate-900 font-mono text-base tracking-tighter">${tx.value.toLocaleString(undefined, {minimumFractionDigits: 2})}</span>
                                <span class="text-[9px] font-black text-orange-500 ml-1">BTC</span>
                            </div>
                            <a href="https://mempool.space/zh/tx/${tx.txid}" target="_blank" class="w-10 h-10 flex items-center justify-center rounded-xl bg-slate-50 text-slate-300 hover:bg-slate-900 hover:text-white transition-all shadow-sm">
                                <i class="fas fa-chevron-right text-[10px]"></i>
                            </a>
                        </div>
                    </div>
                `).join('');

                card.innerHTML = `
                    <div class="flex justify-between items-center pb-4 border-b-2 border-slate-100">
                        <div class="flex items-center gap-4">
                            <div class="w-2 h-8 btc-gradient rounded-full"></div>
                            <span class="text-2xl font-black text-slate-900 font-mono tracking-tighter">BLOCK #${block.height}</span>
                        </div>
                        <div class="flex flex-col items-end">
                            <span class="text-[9px] font-black text-green-600 bg-green-50 px-3 py-1 rounded-full border border-green-200 uppercase tracking-widest flex items-center gap-2">
                                <i class="fas fa-check-double text-[8px]"></i> Verified
                            </span>
                        </div>
                    </div>
                    <div class="space-y-1">${txs}</div>
                `;
                list.appendChild(card);
            });
            const total = Math.ceil(filteredData.length / pageSize);
            document.getElementById('pageInfo').innerText = `PAGE ${currentPage} / ${total || 1}`;
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === total || total === 0;
        }

        function handleSearch() {
            const val = document.getElementById('searchInput').value.trim().toLowerCase();
            filteredData = allData.filter(b => b.height.toString().includes(val) || b.top_txs.some(t => t.txid.toLowerCase().includes(val)));
            currentPage = 1; render();
        }
        function prevPage() { if(currentPage > 1) { currentPage--; render(); } }
        function nextPage() { if(currentPage < Math.ceil(filteredData.length / pageSize)) { currentPage++; render(); } }

        document.getElementById('pw').addEventListener('keypress', (e) => { if (e.key === 'Enter') verify(); });
    </script>
</body>
</html>
