<script>
        let allData = [], filteredData = [], currentPage = 1;
        const pageSize = 15; 
        let whaleChartInstance = null;
        let isHistoryLoaded = false; 

        // 仓库配置
        const REPO_OWNER = 'lovexw';
        const REPO_NAME = 'btc-block-new';
        const START_YEAR = 2026; 
        const START_MONTH = 2; 

        function updateClock() {
            const now = new Date();
            const bjTime = new Date(now.getTime() + (now.getTimezoneOffset() + 480) * 60000);
            document.getElementById('bj-clock').innerText = bjTime.toTimeString().split(' ')[0];
        }
        setInterval(updateClock, 1000);
        updateClock();

        function verify() {
            if(document.getElementById('pw').value === 'habfut.com') {
                showMainContent();
            } else {
                alert('口令错误');
            }
        }
        function skipAuth() { showMainContent(); }
        function showMainContent() {
            document.getElementById('auth-screen').remove();
            const main = document.getElementById('main-content');
            main.classList.replace('hidden', 'flex'); 
            setTimeout(() => main.classList.add('opacity-100'), 50);
            init();
        }

        async function init() {
            try {
                // 使用国内 CDN 加速数据源
                const url = `https://cdn.jsdelivr.net/gh/${REPO_OWNER}/${REPO_NAME}@main/data.json`;
                
                const resp = await fetch(url);
                if (!resp.ok) throw new Error('网络请求失败');
                const data = await resp.json();
                
                updateStats(data);
                processData(data.history);
                render();
                initChart(allData);
            } catch (e) { 
                console.error("初始化失败:", e); 
                document.getElementById('daily-max-txid').innerText = "CDN同步中，请稍后刷新...";
            }
        }

        function updateStats(data) {
            document.getElementById('stat-height').innerText = data.last_height || '-';
            document.getElementById('stat-count').innerText = data.history ? data.history.length : '-'; 
            if(data.daily_max && data.daily_max.value > 0) {
                document.getElementById('daily-max-val').innerText = data.daily_max.value.toFixed(2);
                document.getElementById('daily-max-txid').innerText = data.daily_max.txid;
                document.getElementById('daily-max-link').href = 'https://mempool.space/zh/tx/' + data.daily_max.txid;
            }
        }

        function processData(history) {
            // 1. 去重：防止数据重叠导致图表画回头路
            const uniqueMap = new Map();
            history.forEach(item => uniqueMap.set(item.height, item));
            
            // 2. 排序：列表需要【从新到旧】
            allData = Array.from(uniqueMap.values()).sort((a, b) => b.height - a.height);

            // 3. 补全时间戳
            let nowTs = Math.floor(Date.now() / 1000);
            allData.forEach((item, index) => {
                if(!item.time) item.time = nowTs - (index * 600);
            });
            filteredData = [...allData];
        }

        async function loadAllHistory() {
            if (isHistoryLoaded) return;
            const btn = document.getElementById('btn-all');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>';
            btn.disabled = true;

            const now = new Date();
            let currentYear = now.getFullYear();
            let currentMonth = now.getMonth() + 1;
            let fetchTasks = [];

            while (true) {
                if (currentYear < START_YEAR || (currentYear === START_YEAR && currentMonth < START_MONTH)) break;
                const monthStr = currentMonth.toString().padStart(2, '0');
                const fileUrl = `https://cdn.jsdelivr.net/gh/${REPO_OWNER}/${REPO_NAME}@main/archive/${currentYear}_${monthStr}.json`;
                fetchTasks.push(fetch(fileUrl).then(res => res.ok ? res.json() : []).catch(() => []));
                currentMonth--;
                if (currentMonth === 0) { currentMonth = 12; currentYear--; }
            }

            try {
                const results = await Promise.all(fetchTasks);
                let archivedBlocks = results.flat();
                
                // 合并并去重
                const dataMap = new Map();
                allData.forEach(b => dataMap.set(b.height, b));
                archivedBlocks.forEach(b => dataMap.set(b.height, b));

                // 更新全量数据
                allData = Array.from(dataMap.values()).sort((a, b) => b.height - a.height);
                filteredData = [...allData];

                document.getElementById('stat-count').innerText = allData.length;
                render();
                updateChart('all');

                btn.innerHTML = '全史';
                btn.className = "text-[10px] font-bold px-3 py-1 rounded bg-blue-50 text-blue-600";
                isHistoryLoaded = true;
            } catch (e) {
                console.error("历史加载失败", e);
                btn.innerHTML = '重试';
                btn.disabled = false;
            }
        }

        function initChart(data) {
            const ctx = document.getElementById('whaleChart').getContext('2d');
            
            // 【修复关键点1】图表数据必须严格按【时间从小到大】排序，否则线条会乱跑
            // 取最近 144 个点，然后按时间正序排列
            const chartData = [...data].slice(0, 144).sort((a, b) => a.time - b.time);

            whaleChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.map(d => d.time * 1000), 
                    datasets: [{
                        label: '最大转账 (BTC)',
                        data: chartData.map(d => d.top_txs[0].value),
                        borderColor: '#f97316',
                        backgroundColor: (context) => {
                            const ctx = context.chart.ctx;
                            const gradient = ctx.createLinearGradient(0, 0, 0, 200);
                            gradient.addColorStop(0, 'rgba(249, 115, 22, 0.2)');
                            gradient.addColorStop(1, 'rgba(249, 115, 22, 0)');
                            return gradient;
                        },
                        borderWidth: 2,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        // 【修复关键点2】自定义 Tooltip，强制显示中文时间
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const date = new Date(context[0].parsed.x);
                                    return date.toLocaleString('zh-CN', { 
                                        year: 'numeric', 
                                        month: 'long', 
                                        day: 'numeric', 
                                        hour: '2-digit', 
                                        minute: '2-digit', 
                                        second: '2-digit',
                                        hour12: false 
                                    });
                                }
                            }
                        }
                    },
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: { 
                            type: 'time', 
                            time: { 
                                unit: 'hour', 
                                displayFormats: { hour: 'HH:mm', day: 'MM-dd' },
                                tooltipFormat: 'yyyy-MM-dd HH:mm' // 备用格式
                            },
                            grid: { display: false },
                            ticks: { font: { size: 9 }, color: '#cbd5e1', maxRotation: 0 }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: '#f8fafc', borderDash: [4, 4] },
                            ticks: { font: { size: 9 }, color: '#94a3b8' }
                        }
                    }
                }
            });
        }

        function updateChart(period) {
            ['24h', '7d', 'all'].forEach(p => {
                const btn = document.getElementById(`btn-${p}`);
                if(!btn) return;
                const activeClass = "text-[10px] font-bold px-3 py-1 rounded bg-white shadow-sm text-slate-800 transition";
                const inactiveClass = "text-[10px] font-bold px-3 py-1 rounded text-slate-400 hover:text-slate-600 transition";
                btn.className = (p === period) ? activeClass : inactiveClass;
            });

            let count = allData.length;
            if (period === '24h') count = 144; 
            if (period === '7d') count = 144 * 7; 

            if (period === 'all' && !isHistoryLoaded) { loadAllHistory(); return; }

            // 【修复关键点3】更新数据时，也要强制按时间正序排列
            const newData = [...allData].slice(0, count).sort((a, b) => a.time - b.time);

            whaleChartInstance.data.labels = newData.map(d => d.time * 1000);
            whaleChartInstance.data.datasets[0].data = newData.map(d => d.top_txs[0].value);
            whaleChartInstance.options.scales.x.time.unit = (period === '24h') ? 'hour' : 'day';
            whaleChartInstance.update();
        }

        function render() {
            const list = document.getElementById('block-list');
            list.innerHTML = '';
            const pageItems = filteredData.slice((currentPage-1)*pageSize, currentPage*pageSize);
            
            pageItems.forEach(block => {
                const card = document.createElement('div');
                card.className = 'border border-slate-100 rounded-xl p-3 hover:border-orange-200 transition-colors bg-slate-50/50';
                
                let txs = block.top_txs.map((tx, i) => `
                    <div class="flex justify-between items-center py-1.5 border-b border-slate-100 last:border-0">
                        <div class="flex items-center gap-2 overflow-hidden flex-1">
                            <span class="text-[10px] font-bold text-slate-300 w-4">#${i+1}</span>
                            <span class="font-mono text-[10px] text-slate-500 truncate w-24 sm:w-auto font-medium" title="${tx.txid}">${tx.txid.substring(0, 6)}...${tx.txid.substring(tx.txid.length-6)}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-slate-900 font-mono text-xs">${tx.value.toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 1})}</span>
                            <span class="text-[8px] font-bold text-orange-400">BTC</span>
                            <a href="https://mempool.space/zh/tx/${tx.txid}" target="_blank" class="text-slate-300 hover:text-orange-500 ml-1">
                                <i class="fas fa-external-link-alt text-[10px]"></i>
                            </a>
                        </div>
                    </div>
                `).join('');

                card.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center gap-2">
                            <div class="w-1 h-4 bg-orange-500 rounded-full"></div>
                            <span class="text-sm font-black text-slate-800 font-mono">#${block.height}</span>
                        </div>
                        <span class="text-[9px] font-bold text-green-600 bg-green-50 px-2 py-0.5 rounded-full flex items-center gap-1">
                            <i class="fas fa-check text-[8px]"></i> 确认
                        </span>
                    </div>
                    <div class="space-y-0">${txs}</div>
                `;
                list.appendChild(card);
            });
            const total = Math.ceil(filteredData.length / pageSize);
            document.getElementById('pageInfo').innerText = `第 ${currentPage} / ${total || 1} 页`;
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === total || total === 0;
        }

        function handleSearch() {
            const val = document.getElementById('searchInput').value.trim().toLowerCase();
            filteredData = allData.filter(b => b.height.toString().includes(val) || b.top_txs.some(t => t.txid.toLowerCase().includes(val)));
            currentPage = 1; render();
        }
        function prevPage() { if(currentPage > 1) { currentPage--; render(); } }
        function nextPage() { if(currentPage < Math.ceil(filteredData.length / pageSize)) { currentPage++; render(); } }
        document.getElementById('pw').addEventListener('keypress', (e) => { if (e.key === 'Enter') verify(); });
    </script>
